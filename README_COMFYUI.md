# BadgePatternTool-ComfyUI

徽章图案工具的ComfyUI自定义节点版本，用于批量制作圆形徽章并在A4纸上智能排版。

## 🎯 功能特性

- **圆形徽章裁剪**: 将任意图片裁剪成指定直径的圆形徽章
- **智能A4排版**: 支持网格和紧凑（六边形蜂巢）两种排列模式
- **参数自动优化**: 自动计算最佳缩放比例，使图片完美填充圆形
- **🆕 交互式预览**: 带参考线和网格的可视化预览，所见即所得
- **🆕 参数微调**: 通过下拉菜单快速调整位置和大小，无需猜测数值
- **🆕 可视化引导**: 一边调整一边看效果，裁剪位置完全可控
- **高质量输出**: 支持300-600 DPI的打印级质量
- **灵活参数控制**: 可自定义徽章尺寸、间距、页边距等参数

## 📦 安装方法

### 方法一：直接克隆（推荐）

```bash
cd ComfyUI/custom_nodes/
git clone https://github.com/your-repo/BadgePatternTool-ComfyUI.git
```

### 方法二：手动安装

1. 下载本仓库的所有文件
2. 将整个文件夹复制到 `ComfyUI/custom_nodes/` 目录下
3. 确保文件结构如下：

```
ComfyUI/custom_nodes/BadgePatternTool-ComfyUI/
├── __init__.py
├── nodes.py
└── README_COMFYUI.md
```

### 依赖要求

本节点仅依赖ComfyUI的标准依赖，无需额外安装：
- torch
- numpy
- PIL (Pillow)

## 🚀 使用方法

### 核心节点

#### 1. 圆形徽章裁剪 (CircularCropNode)

将输入图片裁剪成圆形徽章。

**输入参数：**
- `image`: 输入图片
- `diameter_mm`: 徽章直径（毫米），默认58mm
- `scale`: 缩放比例，1.0为原始大小
- `offset_x`: X轴偏移（像素）
- `offset_y`: Y轴偏移（像素）
- `rotation`: 旋转角度（0-360度）
- `dpi`: 分辨率（每英寸点数），默认300

**输出：**
- `圆形徽章`: 裁剪后的圆形图片

**用途：**
- 制作单个圆形徽章
- 精确控制图片在圆形中的位置和大小

---

#### 2. 徽章A4排版 (BadgeLayoutNode)

将多个圆形徽章智能排版到A4纸上。

**输入参数：**
- `images`: 输入图片（可以是批次）
- `diameter_mm`: 徽章直径（毫米）
- `layout_type`: 排版类型
  - `网格`: 规则的行列排列
  - `紧凑`: 六边形蜂巢密排，可放置更多徽章
- `spacing_mm`: 徽章间距（毫米）
- `margin_mm`: 页边距（毫米）
- `dpi`: 分辨率

**输出：**
- `A4排版图`: 完整的A4排版图片

**用途：**
- 批量排版多个徽章用于打印
- 最大化利用A4纸空间

---

#### 3. 自动优化徽章参数 (AutoOptimizeBadgeNode)

自动计算最佳的缩放比例和偏移量。

**输入参数：**
- `image`: 输入图片
- `diameter_mm`: 目标徽章直径
- `dpi`: 分辨率

**输出：**
- `最佳缩放`: 推荐的缩放比例
- `偏移X`: 推荐的X轴偏移
- `偏移Y`: 推荐的Y轴偏移

**用途：**
- 快速获取最佳参数
- 可连接到圆形徽章裁剪节点的对应输入

---

### 🆕 交互辅助节点

#### 4. 交互式预览 (InteractivePreviewNode)

生成带参考线、网格、安全区的预览图，让裁剪位置一目了然。

**输入参数：**
- `image`: 输入图片
- `diameter_mm`: 徽章直径
- `scale`: 缩放比例
- `offset_x`: X轴偏移
- `offset_y`: Y轴偏移
- `dpi`: 分辨率
- `show_grid`: 是否显示网格
- `show_safe_area`: 是否显示安全区

**输出：**
- `预览图`: 带有红色裁剪边界、蓝色安全区、绿色参考线的预览图
- `参数提示`: 当前参数说明和调整建议

**用途：**
- 可视化查看裁剪效果
- 了解主体内容是否在安全区内
- 获得调整参数的具体建议

**预览图说明：**
- 🔴 **红色圆圈**: 最终裁剪边界
- 🔵 **蓝色虚线圈**: 安全区域（建议主体内容保持在此内）
- 🟢 **绿色十字线**: 中心参考线
- ⬜ **灰色网格**: 位置参考

---

#### 5. 参数微调 (ParameterAdjustNode)

通过下拉菜单快速调整参数，无需手动计算数值。

**输入参数：**
- `current_scale`: 当前缩放比例
- `current_offset_x`: 当前X偏移
- `current_offset_y`: 当前Y偏移
- `adjust_scale`: 缩放调整（放大/缩小5%或10%，重置）
- `adjust_x`: X偏移调整（左移/右移10或50像素，重置）
- `adjust_y`: Y偏移调整（上移/下移10或50像素，重置）

**输出：**
- `新缩放`: 调整后的缩放值
- `新偏移X`: 调整后的X偏移
- `新偏移Y`: 调整后的Y偏移
- `变化说明`: 参数变化的详细说明

**用途：**
- 便捷的增量调整
- 避免手动计算参数值
- 支持连续多次微调

**使用示例：**
```
图片偏左 → 选择"右移10" → 还偏左 → 再选"右移10"
图片太小 → 选择"放大5%" → 还有点小 → 再选"放大5%"
```

---

#### 6. 可视化引导裁剪 (VisualGuideCropNode)

一站式节点！同时输出裁剪结果和预览图，最适合新手使用。

**输入参数：**
- `image`: 输入图片
- `diameter_mm`: 徽章直径
- `scale`: 缩放比例
- `offset_x`: X轴偏移
- `offset_y`: Y轴偏移
- `dpi`: 分辨率

**输出：**
- `裁剪结果`: 最终的圆形徽章图片
- `预览图`: 带参考线的预览效果
- `参数信息`: 当前参数总览和调整提示

**用途：**
- 一个节点完成预览和裁剪
- 边调整边看效果
- 减少节点连接复杂度

**推荐场景：**
- 新手入门
- 快速试错调整
- 单张图片精细处理

## 📝 工作流示例

### 示例1：单张图片制作徽章

```
[Load Image] --> [圆形徽章裁剪] --> [Save Image]
                       ↑
                       |
                 (手动调整参数或使用自动优化)
```

### 示例2：批量制作并排版

```
[Load Image] --> [圆形徽章裁剪] --┐
[Load Image] --> [圆形徽章裁剪] --├--> [徽章A4排版] --> [Save Image]
[Load Image] --> [圆形徽章裁剪] --┘
```

### 示例3：使用自动优化

```
[Load Image] --┬--> [自动优化徽章参数] --┐
               |                          ↓
               └--> [圆形徽章裁剪] <--(连接优化参数)
                         ↓
                    [Save Image]
```

### 🆕 示例4：交互式调整（推荐！）

```
[Load Image] --> [可视化引导裁剪] --> [Save Image]
                        ↓
                 (调整参数看预览图)
```

**说明**: 一边调整参数，一边看带参考线的预览图，确认满意后保存"裁剪结果"

### 🆕 示例5：精确微调工作流

```
[Load Image] 
    ↓
[自动优化徽章参数] → (获得初始参数)
    ↓
[参数微调] → (通过下拉菜单调整)
    ↓ (连接新参数)
[圆形徽章裁剪]
    ↓
[Save Image]
```

**说明**: 自动优化提供基础参数，参数微调做精细调整（如"右移10"、"放大5%"）

## 🎨 常用尺寸参考

| 徽章类型 | 直径(mm) | 常见用途 |
|---------|---------|---------|
| 小型 | 32mm | 胸针、书签 |
| 中型 | 58mm | 标准徽章、活动纪念品 |
| 大型 | 75mm | 装饰徽章、展示用 |

## 💡 使用技巧

### 1. 🆕 如何精确控制裁剪位置？

**方法A - 可视化引导（最简单）:**
1. 使用[可视化引导裁剪]节点
2. 调整参数，实时查看预览图中的红圈（裁剪边界）
3. 确保主体内容在蓝圈（安全区）内
4. 满意后保存"裁剪结果"

**方法B - 参数微调（最便捷）:**
1. 先用[自动优化]获得基础参数
2. 使用[参数微调]节点通过下拉菜单调整
3. 选择"右移10"、"放大5%"等选项
4. 输出新参数连接到裁剪节点

**方法C - 交互式预览（最直观）:**
1. 添加[交互式预览]节点
2. 在预览图上看到所有参考线
3. 根据"参数提示"的建议调整
4. 用相同参数执行裁剪

**详细教程**: 查看 [INTERACTIVE_GUIDE.md](INTERACTIVE_GUIDE.md)

### 2. 获得最佳效果

- 使用高分辨率原图（建议至少1000x1000像素）
- DPI设置为300以获得打印级质量
- 使用"自动优化"节点快速获取最佳参数

### 3. 排版优化

- **网格模式**: 适合需要整齐排列的场景
- **紧凑模式**: 可多排版约20-30%的徽章，节省材料
- 调整`spacing_mm`控制徽章间距，建议3-5mm

### 4. A4纸打印参数建议

```
- 徽章直径: 58mm
- 间距: 5mm
- 页边距: 10mm
- DPI: 300
- 排版类型: 紧凑
- 预期数量: 网格模式约12个，紧凑模式约15个
```

## 🔧 常见问题

### Q: 图片被裁切了一部分，如何调整？

A: **推荐方法**（🆕新功能）:
1. 使用[可视化引导裁剪]节点，可以直观看到裁剪边界
2. 使用[参数微调]节点，通过下拉菜单快速调整位置
3. 查看[交互式预览]节点的参考线和调整建议

**传统方法**:
- 使用`scale`参数放大图片
- 调整`offset_x`和`offset_y`移动图片位置
- 使用"自动优化"节点获取推荐参数

**详细教程**: 查看 [INTERACTIVE_GUIDE.md](INTERACTIVE_GUIDE.md)

### Q: 如何制作带出血的徽章？

A: 将`diameter_mm`设置为 `实际直径 + 出血尺寸*2`。例如58mm徽章，3mm出血，设置为64mm。

### Q: 批次图片如何使用？

A: "徽章A4排版"节点支持批次输入，会自动将批次中的每张图片作为独立徽章排版。

### Q: 可以制作非圆形徽章吗？

A: 当前版本仅支持圆形。如需其他形状，可以修改节点代码中的遮罩生成部分。

## 📊 性能说明

- **处理速度**: 单张图片裁剪 < 100ms
- **内存占用**: 每张300DPI的58mm徽章约占用8MB内存
- **推荐批次大小**: 建议每次处理不超过30张图片

## 🤝 贡献

欢迎提交Issue和Pull Request！

如果您有功能建议或发现bug，请在GitHub上提交Issue。

## 📄 许可证

本项目采用MIT许可证。

## 🔗 相关链接

- **原始项目**: [BadgePatternTool](https://github.com/fenglyu1314/BadgePatternTool)
- **ComfyUI**: [https://github.com/comfyanonymous/ComfyUI](https://github.com/comfyanonymous/ComfyUI)

## ⚠️ 注意事项

1. 输出的图片已经是RGB格式，可直接用于打印
2. A4纸尺寸固定为210x297mm（国际标准）
3. 圆形徽章的背景默认为白色
4. 建议打印前先预览A4排版效果

---

**当前版本**: v2.0.0 (ComfyUI版)
**最后更新**: 2025-11-07
**开发者**: BadgePatternTool Team

