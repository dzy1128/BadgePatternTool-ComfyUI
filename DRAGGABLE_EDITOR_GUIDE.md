# 🎮 可拖拽编辑器 - 使用指南

## ✨ 新功能：真正的拖拽和缩放！

现在您可以直接在节点内**用鼠标拖拽图片、滚轮缩放**了！

---

## 🆕 可拖拽编辑器节点

### 节点名称
**🎮 可拖拽编辑器** (DraggableEditorNode)

### 核心特性

✅ **鼠标拖拽** - 在编辑器画布上直接拖动图片位置  
✅ **滚轮缩放** - 滚动鼠标滚轮实时放大/缩小  
✅ **实时预览** - 显示红色裁剪边界和绿色中心线  
✅ **参数同步** - 拖拽和缩放自动更新参数值  
✅ **键盘快捷键** - 按R键重置位置和缩放  

---

## 📦 文件结构

```
BadgePatternTool-ComfyUI/
├── nodes.py              # 后端节点（已更新）
└── js/
    └── badge_editor.js   # 前端交互实现（新建）
```

---

## 🚀 使用方法

### 基础工作流

```
[Load Image] 
    ↓
[🎮 可拖拽编辑器]  ← 在这里拖拽和缩放！
    ↓
[Save Image]
```

### 操作步骤

1. **添加节点**
   - 右键 → "徽章工具/可拖拽编辑"
   - 选择 "🎮 可拖拽编辑器"

2. **连接图片**
   - 将Load Image的输出连接到编辑器的image输入

3. **等待加载**
   - 图片连接后会自动尝试加载预览
   - 如果没有显示，执行一次工作流

4. **鼠标操作**
   - **拖拽**: 在编辑器区域按住鼠标左键拖动
   - **缩放**: 在编辑器区域滚动鼠标滚轮
   - **重置**: 按键盘R键重置到初始状态

5. **查看效果**
   - 🔴 红色圆圈 = 裁剪边界
   - 🟢 绿色十字 = 圆心
   - 底部显示当前参数值

6. **保存结果**
   - 调整满意后，执行工作流
   - 保存"裁剪结果"输出

---

## 🎨 界面说明

### 编辑器画布（300px）

```
┌────────────────────────────┐
│     [编辑器画布区域]       │
│                            │
│      ┌────🟢────┐          │
│      │    图片   │          │
│   🟢─┼───🔴───┼─🟢       │
│      │         │          │
│      └────🟢────┘          │
│                            │
│  缩放: 1.20x | 偏移: (45,-20) │
│  拖拽图片 | 滚轮缩放 | R重置   │
└────────────────────────────┘
```

### 视觉元素

- **深灰背景**: 编辑区域
- **🔴 红色圆圈**: 最终裁剪边界
- **🟢 绿色十字**: 中心参考点
- **底部文字**: 实时参数显示
- **提示文字**: 操作说明

---

## 🎮 操作说明

### 鼠标操作

| 操作 | 效果 |
|-----|------|
| **左键拖拽** | 移动图片位置 |
| **滚轮向上** | 放大图片 |
| **滚轮向下** | 缩小图片 |

### 键盘操作

| 按键 | 效果 |
|-----|------|
| **R** | 重置位置和缩放 |

### 参数范围

- **scale**: 0.1 ~ 5.0
- **offset_x**: -2000 ~ 2000
- **offset_y**: -2000 ~ 2000

---

## 💡 使用技巧

### 技巧1：精确定位

1. 先用拖拽大致移动到位
2. 再用滚轮调整大小
3. 最后微调位置
4. 对准绿色十字使主体居中

### 技巧2：快速重置

- 拖乱了？按R键立即重置
- 或者手动设置参数为0

### 技巧3：参数导出

```
[Load Image]
    ↓
[🎮 可拖拽编辑器]
    ├─→ 裁剪结果 → [Save Image]
    ├─→ 当前缩放 ─┐
    ├─→ 当前偏移X ┼→ [连接到其他节点]
    └─→ 当前偏移Y ┘
```

可以将找到的参数输出给其他节点使用

### 技巧4：批量处理

1. 用可拖拽编辑器调整第一张图
2. 记录最终参数值
3. 其他图片使用"圆形徽章裁剪"节点
4. 应用相同参数

---

## 🔧 技术实现

### 前端（JavaScript）

**文件**: `js/badge_editor.js`

**核心功能**:
- 自定义Widget绘制
- Canvas渲染
- 鼠标事件处理（拖拽、滚轮）
- 参数实时同步

**关键代码**:
```javascript
// 创建自定义widget
function createDraggableEditor(node, inputName, inputData, app) {
    const widget = {
        type: "badge_draggable_editor",
        draw: function(ctx, node, width, y, height) {
            // Canvas绘制逻辑
        },
        mouse: function(event, pos, node) {
            // 鼠标事件处理
        }
    };
    return widget;
}
```

### 后端（Python）

**文件**: `nodes.py`

**核心类**:
```python
class DraggableEditorNode:
    def process(self, image, diameter_mm, dpi, 
                scale=1.0, offset_x=0, offset_y=0):
        # 使用参数裁剪图片
        # 前端会自动更新这些参数
```

---

## 📊 完整工作流示例

### 示例1：单张图片精细调整

```
[Load Image] 
    ↓
[🎮 可拖拽编辑器]
    ↓ (拖拽和缩放调整)
[Preview Image] (查看效果)
    ↓
[Save Image]
```

### 示例2：批量处理（先找参数）

```
步骤1: 找参数
[Load Image (第1张)]
    ↓
[🎮 可拖拽编辑器]
    ↓ 拖拽找到: scale=1.2, offset_x=30, offset_y=-15
    
步骤2: 批量应用
[Load Image (批次)]
    ↓
[圆形徽章裁剪] (使用上面的参数)
    ↓
[徽章A4排版]
    ↓
[Save Image]
```

### 示例3：参数链接

```
[Load Image]
    ↓
[🎮 可拖拽编辑器]
    ├─→ 裁剪结果 → [Preview Image]
    └─→ 当前缩放/偏移 → [显示或连接其他节点]
```

---

## 🆚 对比其他节点

| 节点 | 交互方式 | 优点 | 适用场景 |
|-----|---------|------|---------|
| **🎮 可拖拽编辑器** | 鼠标直接拖拽 | 最直观、最快速 | 单张精细调整 |
| 圆形徽章裁剪 | 输入参数值 | 精确、批量友好 | 已知参数值 |
| 交互式预览 | 参数+预览图 | 有参考线 | 需要预览图 |
| 参数微调 | 下拉菜单 | 渐进式调整 | 小幅调整 |

---

## 🐛 故障排除

### Q1: 看不到可拖拽编辑器节点？

**检查**:
1. 确认 `js/badge_editor.js` 文件存在
2. 检查 `nodes.py` 中的 `WEB_DIRECTORY = "./js"`
3. 完全重启ComfyUI（不是刷新）

**验证**:
- 浏览器控制台（F12）应显示："✅ BadgePatternTool 可拖拽编辑器已加载"

---

### Q2: 编辑器显示空白？

**可能原因**:
- 图片还未连接
- 图片预览加载失败

**解决**:
1. 确保已连接Load Image
2. 执行一次工作流
3. 如果还是空白，操作仍然有效（参数会同步）

---

### Q3: 拖拽不响应？

**检查**:
1. 鼠标是否在编辑器画布区域内
2. 是否正确加载前端JS
3. 浏览器控制台是否有错误

**解决**:
- 清空浏览器缓存（Ctrl+Shift+Delete）
- 强制刷新（Ctrl+F5）
- 重启ComfyUI

---

### Q4: 参数不同步？

**现象**: 拖拽后参数值没变化

**检查**:
- scale, offset_x, offset_y widget是否存在
- 查看浏览器控制台错误

**解决**:
- 确保使用的是"可拖拽编辑器"节点
- 不是其他节点

---

## 📏 参数说明

### 输入参数

| 参数 | 类型 | 默认值 | 说明 |
|-----|------|-------|------|
| `image` | IMAGE | - | 输入图片 |
| `diameter_mm` | FLOAT | 58.0 | 徽章直径（毫米）|
| `dpi` | INT | 300 | 分辨率 |
| `scale` | FLOAT | 1.0 | 缩放比例（可选）|
| `offset_x` | INT | 0 | X偏移（可选）|
| `offset_y` | INT | 0 | Y偏移（可选）|

### 输出参数

| 输出 | 类型 | 说明 |
|-----|------|------|
| `裁剪结果` | IMAGE | 最终的圆形徽章 |
| `当前缩放` | FLOAT | 当前缩放值 |
| `当前偏移X` | INT | 当前X偏移值 |
| `当前偏移Y` | INT | 当前Y偏移值 |

---

## 🎓 学习建议

### Day 1：熟悉操作
```
目标: 掌握拖拽和缩放
练习: 导入一张图片，随意拖动和缩放
```

### Day 2：精确控制
```
目标: 能精确定位主体
练习: 将人脸/Logo对准圆心
```

### Day 3：实战应用
```
目标: 完整工作流
练习: 从导入到保存，完成全流程
```

---

## 🎉 总结

### 核心优势

✅ **真正的拖拽** - 鼠标直接操作，不是参数输入  
✅ **实时反馈** - 拖拽即显示，无需执行工作流  
✅ **所见即所得** - 编辑器效果=最终效果  
✅ **参数同步** - 自动更新，可导出复用  

### 使用场景

- ✨ **单张图片精细调整** - 最佳选择
- ✨ **快速找最佳参数** - 然后批量应用
- ✨ **实时预览调整** - 边拖边看

---

**享受真正的拖拽编辑体验！** 🎮✨

---

**创建时间**: 2025-11-07  
**版本**: v2.3  
**状态**: ✅ 完整实现

