# 测试指南 - Testing Guide

## 测试方法

### 方法1：在ComfyUI中手动测试（推荐）

这是最可靠的测试方法，因为可以直接使用ComfyUI的环境。

#### 基本功能测试

1. **测试圆形裁剪节点**
   - 添加 "Load Image" 节点
   - 添加 "圆形徽章裁剪" 节点
   - 连接并设置参数
   - 添加 "Save Image" 查看结果
   - 预期：图片被裁剪成圆形

2. **测试自动优化节点**
   - 添加 "Load Image" 节点
   - 添加 "自动优化徽章参数" 节点
   - 查看输出的缩放和偏移值
   - 预期：返回合理的数值

3. **测试A4排版节点**
   - 准备多张图片（使用Load Image的批次模式）
   - 添加 "徽章A4排版" 节点
   - 尝试"网格"和"紧凑"两种模式
   - 预期：生成A4尺寸的排版图

#### 集成工作流测试

创建以下完整工作流：

```
[Load Image] → [自动优化徽章参数] → [圆形徽章裁剪] → [徽章A4排版] → [Save Image]
                        ↓                    ↑
                        └─（连接优化参数）────┘
```

### 方法2：使用Python脚本测试

如果您有独立的Python环境且已安装torch：

```bash
# 确保安装了依赖
pip install torch numpy Pillow

# 运行测试
cd /path/to/BadgePatternTool-ComfyUI
python test_nodes.py
```

## 测试检查清单

### 圆形裁剪节点 ✓

- [ ] 默认参数能正常裁剪
- [ ] 缩放参数生效（0.1-5.0）
- [ ] 偏移参数生效（X和Y）
- [ ] 旋转参数生效（0-360度）
- [ ] 不同DPI设置正常工作
- [ ] 输出图片为圆形
- [ ] 输出尺寸与diameter_mm对应

### 自动优化节点 ✓

- [ ] 横向图片能计算正确
- [ ] 纵向图片能计算正确
- [ ] 正方形图片能计算正确
- [ ] 返回值在合理范围内
- [ ] 不同徽章尺寸都能优化

### A4排版节点 ✓

- [ ] 网格模式正常工作
- [ ] 紧凑模式正常工作
- [ ] 输出尺寸为A4（2480x3508px @300dpi）
- [ ] 间距参数生效
- [ ] 页边距参数生效
- [ ] 批次图片正确放置
- [ ] 空位显示占位符

### 参数范围测试

| 参数 | 最小值 | 最大值 | 推荐值 |
|-----|-------|-------|-------|
| diameter_mm | 10 | 200 | 58 |
| scale | 0.1 | 5.0 | 1.0 |
| offset_x | -1000 | 1000 | 0 |
| offset_y | -1000 | 1000 | 0 |
| rotation | 0 | 360 | 0 |
| spacing_mm | 0 | 20 | 5 |
| margin_mm | 0 | 50 | 10 |
| dpi | 72 | 600 | 300 |

## 预期输出

### 圆形裁剪节点

- **输入**: 任意尺寸的图片
- **输出**: 圆形图片，直径 = diameter_mm / 25.4 * dpi 像素
- **示例**: 58mm @ 300dpi = 689像素

### A4排版节点

- **输入**: 批次圆形图片
- **输出**: A4尺寸图片 (2480x3508px @ 300dpi)
- **网格模式**: 约12-15个徽章（58mm）
- **紧凑模式**: 约15-18个徽章（58mm）

## 常见测试问题

### 问题1：节点不出现

**检查：**
- 文件结构是否正确
- `__init__.py` 和 `nodes.py` 是否存在
- ComfyUI是否重启
- 控制台是否有错误

### 问题2：图片质量差

**检查：**
- DPI是否设置为300
- 输入图片分辨率是否足够
- scale参数是否合理

### 问题3：排版图片空白

**检查：**
- 输入是否为批次图片
- 图片是否已经是圆形
- 徽章直径是否过大
- 页边距是否过大

### 问题4：参数不生效

**检查：**
- 是否重新执行了工作流
- 参数值是否在有效范围内
- 节点连接是否正确

## 性能测试

### 处理时间参考（300 DPI）

- 圆形裁剪（800x600图片）: ~50-100ms
- A4排版（12个徽章）: ~200-400ms
- 自动优化: ~10-20ms

### 内存占用参考

- 单个58mm @ 300dpi徽章: ~8MB
- A4排版图: ~25MB
- 10个徽章批次: ~100MB

## 调试技巧

1. **查看ComfyUI控制台输出**
   - 错误信息会显示在这里
   - Python异常的完整堆栈跟踪

2. **使用Preview Image节点**
   - 在关键步骤后添加预览
   - 确认每一步的输出

3. **简化工作流**
   - 先测试单个节点
   - 逐步添加复杂度

4. **检查输入格式**
   - 确保图片是IMAGE类型
   - 确认批次维度正确

## 报告Bug

如果发现问题，请提供：

1. ComfyUI版本
2. 节点版本
3. 使用的参数
4. 控制台错误信息
5. 工作流JSON（如果可能）
6. 输入图片的规格

在GitHub上提交Issue: https://github.com/your-repo/BadgePatternTool-ComfyUI/issues

## 自动化测试（高级）

如果您想要设置CI/CD：

```bash
# 安装测试依赖
pip install pytest torch torchvision numpy Pillow

# 运行pytest
pytest test_nodes.py -v

# 生成覆盖率报告
pytest --cov=nodes --cov-report=html
```

注意：需要创建pytest兼容的测试文件。

---

**测试完成后，请在GitHub上给我们反馈！**

